<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Administrador - NUAM</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;}
    body{
      display:flex;
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      overflow: hidden;
      animation: colorChange 5s infinite;
    }
    @keyframes colorChange {
      0%{background-color: black;}
      50%{background-color: red;}
      100%{background-color: black;}
    }
    .left-box{
      width:320px;height:100vh;
      background:rgba(0,0,0,.7);
      color:#fff;
      padding:30px 20px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .left-box h3{font-size:18px;margin-bottom:10px;}
    .btn-group{display:flex;gap:6px;}
    .btn{
      flex:1;height:36px;border:none;border-radius:6px;
      font-size:14px;font-weight:bold;cursor:pointer;
      background:transparent;
      color:#fff;
      border:1px solid #fff;
      box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000;
      transition: box-shadow 0.3s ease;
    }
    .btn:hover{
      background:#ff0000;
      color:#000;
      box-shadow: 0 0 15px #ff0000, 0 0 25px #ff0000, 0 0 35px #ff0000;
    }
    .right-box{
      flex:1;display:flex;align-items:flex-start;justify-content:center;
      padding:40px 20px; overflow-y:auto;
    }
    .card{
      width:90%;max-width:420px;
      background:rgba(0,0,0,.6);
      border-radius:12px;padding:30px;
      color:#fff;display:flex;flex-direction:column;gap:15px;
    }
    .card h2{font-size:22px;text-align:center;margin-bottom:10px;}
    label{font-size:14px;margin-bottom:4px;}
    input,select,textarea{
      width:100%;height:48px;border:none;border-radius:8px;
      padding:0 15px;font-size:16px;
      background:rgba(255,255,255,.1);color:#fff;outline:none;
    }
    input::placeholder{color:#ccc;}
    .btn-success{width:100%;height:48px;border:none;border-radius:8px;
                 font-size:16px;font-weight:bold;cursor:pointer;
                 background:#198754;color:#fff;}
    .btn-success:hover{background:#157347;}
    .btn-danger{
      background-color: #dc3545;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000;
    }
    .btn-danger:hover{background-color: #c82333;}
    .sql-table{display:flex;flex-direction:column;gap:10px;}
    .sql-row{display:flex;justify-content:space-between;align-items:center;
             background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.2);
             border-radius:8px;padding:12px 16px;transition:background .3s ease;}
    .sql-row:hover{background:rgba(255,255,255,.1);}
    .sql-cell{flex:1;font-size:14px;line-height:1.5;}
    .sql-action{display:flex;gap:10px;}
    @media(max-width:768px){body{flex-direction:column;}.left-box{width:100%;height:auto;}}

    /* =====  Scroll personalizado (estilo 2)  ===== */
    ::-webkit-scrollbar{
      width:12px;
    }
    ::-webkit-scrollbar-track{
      background:#111;
    }
    ::-webkit-scrollbar-thumb{
      background:#ff0000;
      border-radius:6px;
    }
    ::-webkit-scrollbar-thumb:hover{
      background:#c82333;
    }
  </style>
</head>
<body>

<div class="left-box">
  <h3>Admin - Opciones</h3>

  <div class="btn-group">
    <a href="?seccion=calificacion&accion=crear" class="btn">Crear Calificaci√≥n</a>
    <a href="?seccion=calificacion&accion=editar" class="btn">Editar Calificaci√≥n</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=usuario&accion=crear" class="btn">Crear Usuario</a>
    <a href="?seccion=usuario&accion=editar" class="btn">Editar Usuario</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=instrumento&accion=crear" class="btn">Crear Instrumento</a>
    <a href="?seccion=instrumento&accion=editar" class="btn">Editar Instrumento</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=rol&accion=crear" class="btn">Crear Rol</a>
    <a href="?seccion=rol&accion=editar" class="btn">Editar Rol</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=permiso&accion=crear" class="btn">Crear Permiso</a>
    <a href="?seccion=permiso&accion=editar" class="btn">Editar Permiso</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=asignacion_permisos" class="btn">Asignaci√≥n de Permisos</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=asignacion_permisos_editacion" class="btn">Editar Asignaciones</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=filtrar" class="btn">Filtrar Calificaciones</a>
  </div>

  <div class="btn-group">
    <a href="{% url 'visualizar_usuarios' %}" class="btn">Visualizaci√≥n de Usuarios</a>
  </div>

  <h3 class="mt-4">Carga masiva</h3>
  <form method="post" action="{% url 'carga_masiva' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="archivo" accept=".json,.csv" required>
    <button type="submit" class="btn">Subir archivo</button>
  </form>

  <div class="btn-group">
    <a href="{% url 'logout' %}" class="btn btn-danger">Cerrar sesi√≥n</a>
  </div>
</div>

<div class="right-box">
  {% if seccion == 'calificacion' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Calificaci√≥n</h2>
      <form method="post" action="{% url 'guardar_calificacion' %}">
        {% csrf_token %}
        <input type="hidden" name="usuario_id_usuario" value="{{ request.user.id }}">
        <label>Monto ($)</label><input type="text" name="monto" class="solo-float" required>
        <label>Factor (%)</label><input type="text" name="factor" class="solo-float" required>
        <label>Per√≠odo</label><input type="month" name="periodo" max="{{hoy|date:'Y-m'}}" required>
        <label>Instrumento</label>
        <select name="instrumento" required>
          <option value="">-- Seleccione --</option>
          {% for i in instrumentos %}<option value="{{ i.id_instru }}">{{ i.nombre }}</option>{% endfor %}
        </select>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>
        <label>Usuario</label>
        <select name="usuario_id_usuario" required>
          <option value="">-- Seleccione</option>
          {% for u in usuarios %}<option value="{{ u.id_usuario }}">{{ u.nombre }}</option>{% endfor %}
        </select>
        <label>Factor Val</label>
        <select name="factor_val_id_factor" required>
          <option value="">-- Seleccione</option>
          {% for fv in factor_vals %}<option value="{{ fv.id_factor }}">{{ fv.id_factor }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Crear Calificaci√≥n</button>
      </form>
    </div>

  {% elif seccion == 'calificacion' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione una Calificaci√≥n para Editar</h2>
      <div class="sql-table">
        {% for c in calificaciones %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Instrumento:</strong> {{ c.instrumento.nombre }}<br>
              <strong>Per√≠odo:</strong> {{ c.periodo|date:"m/Y" }}<br>
              <strong>Monto:</strong> ${{ c.monto|floatformat:0 }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=calificacion&accion=editar&obj_id={{ c.calid }}">Editar</a>
              <a class="btn-danger" href="{% url 'eliminar_calificacion' c.calid %}" onclick="return confirm('¬øEst√°s seguro de eliminar esta calificaci√≥n?')">Eliminar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'calificacion' and accion == 'editar' and obj %}
    <div class="card">
      <h2>Editar Calificaci√≥n</h2>
      <form method="post" action="{% url 'actualizar_calificacion' obj.calid %}">
        {% csrf_token %}
        <label>Monto ($)</label><input type="text" name="monto" value="{{ obj.monto }}" class="solo-float" required>
        <label>Factor (%)</label><input type="text" name="factor" value="{{ obj.factor }}" class="solo-float" required>
        <label>Per√≠odo</label><input type="month" name="periodo" value="{{ obj.periodo|date:'Y-m' }}" required>
        <label>Instrumento</label>
        <select name="instrumento" required>
          {% for i in instrumentos %}<option value="{{ i.id_instru }}" {% if i.id_instru == obj.instrumento.id_instru %}selected{% endif %}>{{ i.nombre }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'usuario' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Usuario</h2>
      <form method="post" action="{% url 'guardar_usuario' %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" class="solo-texto" required>
        <label>RUT (sin puntos, con gui√≥n)</label><input type="text" name="rut" class="solo-rut" required>
        <label>Email</label><input type="email" name="email" required>
        <label>Contrase√±a</label>
        <input type="password" name="password" required minlength="8" placeholder="M√≠nimo 8 caracteres">
        <label>Rol</label>
        <select name="rol" required>
          {% for r in roles %}<option value="{{ r.id_rol }}">{{ r.nombre_rol }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Crear Usuario</button>
      </form>
    </div>

  {% elif seccion == 'usuario' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Usuario para Editar</h2>
      <div class="sql-table">
        {% for u in usuarios %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Nombre:</strong> {{ u.nombre }}<br>
              <strong>RUT:</strong> {{ u.rut }}<br>
              <strong>Rol:</strong> {{ u.rol_id.nombre_rol }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=usuario&accion=editar&obj_id={{ u.id_usuario }}">Editar</a>
              <a class="btn-danger" href="{% url 'eliminar_usuario' u.id_usuario %}" onclick="return confirm('¬øEst√°s seguro de eliminar este usuario?')">Eliminar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'usuario' and accion == 'editar' and obj %}
    <div class="card">
      <h2>Editar Usuario</h2>
      <form method="post" action="{% url 'actualizar_usuario' obj.id_usuario %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" value="{{ obj.nombre }}" class="solo-texto" required>
        <label>RUT (sin puntos, con gui√≥n)</label><input type="text" name="rut" value="{{ obj.rut }}" class="solo-rut" required>
        <label>Email</label><input type="email" name="email" value="{{ obj.email }}" required>
        <label>Nueva Contrase√±a (opcional)</label>
        <input type="password" name="password" placeholder="Dejar vac√≠o para mantener la actual">
        <label>Rol</label>
        <select name="rol" required>
          {% for r in roles %}<option value="{{ r.id_rol }}" {% if r.id_rol == obj.rol_id.id_rol %}selected{% endif %}>{{ r.nombre_rol }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'instrumento' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Instrumento</h2>
      <form method="post" action="{% url 'guardar_instrumento' %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" class="solo-texto" required>
        <label>Regla</label><textarea name="regla_es" class="form-control" rows="3" required></textarea>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>
        <button type="submit" class="btn-success mt-3">Crear Instrumento</button>
      </form>
    </div>

  {% elif seccion == 'instrumento' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Instrumento para Editar</h2>
      <div class="sql-table">
        {% for i in instrumentos %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Nombre:</strong> {{ i.nombre }}<br>
              <strong>Estado:</strong> {{ i.estado }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=instrumento&accion=editar&obj_id={{ i.id_instru }}">Editar</a>
              <a class="btn-danger" href="{% url 'eliminar_instrumento' i.id_instru %}" onclick="return confirm('¬øEst√°s seguro de eliminar este instrumento?')">Eliminar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'instrumento' and accion == 'editar' and obj %}
    <div class="card">
      <h2>Editar Instrumento</h2>
      <form method="post" action="{% url 'actualizar_instrumento' obj.id_instru %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" value="{{ obj.nombre }}" class="solo-texto" required>
        <label>Regla</label><textarea name="regla_es" class="form-control" rows="3" required>{{ obj.regla_es }}</textarea>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO" {% if obj.estado == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
          <option value="INACTIVO" {% if obj.estado == 'INACTIVO' %}selected{% endif %}>INACTIVO</option>
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'rol' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Rol</h2>
      <form method="post" action="{% url 'guardar_rol' %}">
        {% csrf_token %}
        <label>Nombre del Rol</label><input type="text" name="nombre_rol" class="solo-texto" required>
        <label>Descripci√≥n</label><textarea name="descripcion_rol" class="form-control solo-texto" rows="3" required></textarea>
        <button type="submit" class="btn-success mt-3">Crear Rol</button>
      </form>
    </div>

  {% elif seccion == 'rol' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Rol para Editar</h2>
      <div class="sql-table">
        {% for r in roles %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Rol:</strong> {{ r.nombre_rol }}<br>
              <strong>Descripci√≥n:</strong> {{ r.descripcion_rol|truncatewords:10 }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=rol&accion=editar&obj_id={{ r.id_rol }}">Editar</a>
              <a class="btn-danger" href="{% url 'eliminar_rol' r.id_rol %}" onclick="return confirm('¬øEst√°s seguro de eliminar este rol?')">Eliminar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'rol' and accion == 'editar' and obj %}
    <div class="card">
      <h2>Editar Rol</h2>
      <form method="post" action="{% url 'guardar_rol' %}">
        {% csrf_token %}
        <input type="hidden" name="id_rol" value="{{ obj.id_rol }}">
        <label>Nombre del Rol</label><input type="text" name="nombre_rol" value="{{ obj.nombre_rol }}" class="solo-texto" required>
        <label>Descripci√≥n</label><textarea name="descripcion_rol" class="form-control solo-texto" rows="3" required>{{ obj.descripcion_rol }}</textarea>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'permiso' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Permiso</h2>
      <form method="post" action="{% url 'guardar_permiso' %}">
        {% csrf_token %}
        <label>Nombre del Permiso</label><input type="text" name="nombre" class="solo-texto" required>
        <label>Descripci√≥n</label><textarea name="descripcion" class="form-control solo-texto" rows="3" required></textarea>
        <button type="submit" class="btn-success mt-3">Crear Permiso</button>
      </form>
    </div>

  {% elif seccion == 'permiso' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Permiso para Editar</h2>
      <div class="sql-table">
        {% for p in permisos %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Permiso:</strong> {{ p.nombre }}<br>
              <strong>Descripci√≥n:</strong> {{ p.descripcion_permiso|truncatewords:10 }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=permiso&accion=editar&obj_id={{ p.id_permiso }}">Editar</a>
              <a class="btn-danger" href="{% url 'eliminar_permiso' p.id_permiso %}" onclick="return confirm('¬øEst√°s seguro de eliminar este permiso?')">Eliminar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'permiso' and accion == 'editar' and obj_id %}
    <div class="card">
      <h2>Editar Permiso</h2>
      <form method="post" action="{% url 'guardar_permiso' %}">
        {% csrf_token %}
        <input type="hidden" name="id_permiso" value="{{ obj.id_permiso }}">
        <label>Nombre del Permiso</label><input type="text" name="nombre" value="{{ obj.nombre }}" class="solo-texto" required>
        <label>Descripci√≥n</label><textarea name="descripcion" class="form-control solo-texto" rows="3" required>{{ obj.descripcion_permiso }}</textarea>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'filtrar' %}
    <div class="card">
      <h2>Filtrar Calificaciones</h2>
      <form method="get" action="{% url 'filtrar_calificaciones' %}">
        <label>RUT (sin puntos, con gui√≥n)</label><input type="text" name="rut">
        <label>Fecha (per√≠odo)</label><input type="month" name="fecha">
        <label>Monto m√≠nimo</label><input type="text" name="monto_min" placeholder="0" class="solo-float">
        <label>Monto m√°ximo</label><input type="text" name="monto_max" placeholder="999999999" class="solo-float">
        <label>Tipo de instrumento</label><input type="text" name="instrumento" placeholder="Ej: Bono" class="solo-texto">
        <label>Factor Val ID</label><input type="number" name="factor_val" placeholder="Ej: 1">
        <button type="submit" class="btn-success mt-3">Buscar</button>
      </form>
    </div>

  {% elif seccion == 'asignacion_permisos' %}
    <div class="card">
      <h2>Asignar Permiso a Rol</h2>
      <form method="post" action="{% url 'gestionar_asignacion_permisos' %}">
        {% csrf_token %}
        <label>Rol</label>
        <select name="rol" required>
          <option value="">-- Seleccione un rol --</option>
          {% for r in roles %}
            <option value="{{ r.id_rol }}">{{ r.nombre_rol }}</option>
          {% endfor %}
        </select>

        <label>Permiso</label>
        <select name="permiso" required>
          <option value="">-- Seleccione un permiso --</option>
          {% for p in permisos %}
            <option value="{{ p.id_permiso }}">{{ p.nombre }}</option>
          {% endfor %}
        </select>

        <input type="hidden" name="accion" value="crear">
        <button type="submit" class="btn-success mt-3">Asignar Permiso</button>
      </form>
    </div>

  {% elif seccion == 'asignacion_permisos_editacion' %}
    <div class="card">
      <h2>Editar / Eliminar Asignaciones de Permisos</h2>
      <div class="sql-table">
        {% for a in asignaciones %}
          <div class="sql-row">
            <form method="post" action="{% url 'gestionar_asignacion_permisos_editacion' %}" style="width:100%;display:flex;justify-content:space-between;align-items:center;gap:10px;">
              {% csrf_token %}
              <input type="hidden" name="asignacion_id" value="{{ a.id }}">
              <input type="hidden" name="accion" value="editar">

              <div class="sql-cell" style="flex:1;">
                <label>Rol</label><br>
                <select name="nuevo_rol" style="width:100%;">
                  {% for r in roles %}
                    <option value="{{ r.id_rol }}" {% if r.id_rol == a.rol.id_rol %}selected{% endif %}>{{ r.nombre_rol }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="sql-cell" style="flex:1;">
                <label>Permiso</label><br>
                <select name="nuevo_permiso" style="width:100%;">
                  {% for p in permisos %}
                    <option value="{{ p.id_permiso }}" {% if p.id_permiso == a.permiso.id_permiso %}selected{% endif %}>{{ p.nombre }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="sql-action" style="display:flex;gap:6px;">
                <button type="submit" class="btn" title="Guardar cambios">üíæ</button>
                <button type="submit" formaction="{% url 'gestionar_asignacion_permisos_editacion' %}?accion=eliminar" name="accion" value="eliminar" class="btn-danger" title="Eliminar asignaci√≥n" onclick="return confirm('¬øEst√°s seguro de eliminar esta asignaci√≥n?')">üóëÔ∏è</button>
              </div>
            </form>
          </div>
        {% empty %}
          <p style="color:#ccc;">No hay asignaciones creadas a√∫n.</p>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<script>
// ---------- TEXTOS: letras y espacios, sin n√∫meros, no vac√≠o ----------
document.querySelectorAll('.solo-texto').forEach(function(inp){
  inp.addEventListener('input', function(){
    this.value = this.value.replace(/[0-9]/g, '');
  });
  inp.addEventListener('blur', function(){
    this.value = this.value.trim();
    if (this.value === '') {
      this.setCustomValidity('Campo obligatorio (no solo espacios)');
    } else {
      this.setCustomValidity('');
    }
  });
});

// ---------- FLOATS: solo n√∫meros, punto, sin letras, sin negativos ----------
document.querySelectorAll('.solo-float').forEach(function(inp){
  inp.addEventListener('input', function(){
    let v = this.value;
    v = v.replace(/[^0-9.]/g, '');
    let parts = v.split('.');
    if (parts.length > 2) v = parts[0] + '.' + parts.slice(1).join('');
    if (v.startsWith('.')) v = '0' + v;
    if (v.startsWith('-')) v = v.slice(1);
    this.value = v;
  });
  inp.addEventListener('blur', function(){
    let n = parseFloat(this.value);
    if (isNaN(n) || n < 0) {
      this.setCustomValidity('N√∫mero positivo obligatorio');
    } else {
      this.setCustomValidity('');
    }
  });
});

// ---------- RUT: solo n√∫meros y k/K ----------
document.querySelectorAll('.solo-rut').forEach(function(inp){
  inp.addEventListener('input', function(){
    this.value = this.value.replace(/[^0-9kK-]/g, '');
  });
});
</script>

</body>
</html>

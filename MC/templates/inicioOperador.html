<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Operador - NUAM</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;}
    body{display:flex;background:linear-gradient(to bottom,#ff0000 50%,#000000 50%);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:#ffffff;}
    .left-box{width:320px;height:100vh;background:rgba(0,0,0,0.7);padding:30px 20px;display:flex;flex-direction:column;gap:10px;}
    .left-box h3{font-size:18px;margin-bottom:10px;}
    .btn-group{display:flex;gap:6px;}
    .btn{flex:1;height:36px;border:none;border-radius:6px;font-size:14px;font-weight:bold;cursor:pointer;background-color:#ff0000;color:#ffffff;transition:background-color 0.3s ease;}
    .btn:hover{background-color:#cc0000;}
    .btn-outline-light{background:transparent;color:#ffffff;border:1px solid #ffffff;}
    .btn-outline-light:hover{background:#ffffff;color:#000000;}
    .right-box{flex:1;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;}
    .card{width:90%;max-width:420px;background:rgba(0,0,0,0.6);border-radius:12px;padding:30px;display:flex;flex-direction:column;gap:15px;}
    .card h2{font-size:22px;text-align:center;margin-bottom:10px;}
    label{font-size:14px;margin-bottom:4px;}
    input,select,textarea{width:100%;height:48px;border:none;border-radius:8px;padding:0 15px;font-size:16px;background:rgba(255,255,255,0.1);color:#ffffff;outline:none;}
    input::placeholder{color:#cccccc;}
    .btn-success{width:100%;height:48px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;background:#198754;color:#ffffff;transition:background-color 0.3s ease;}
    .btn-success:hover{background:#157347;}
    .sql-table{display:flex;flex-direction:column;gap:10px;}
    .sql-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:12px 16px;transition:background 0.3s ease;}
    .sql-row:hover{background:rgba(255,255,255,0.1);}
    .sql-cell{flex:1;font-size:14px;line-height:1.5;}
    .sql-action{margin-left:20px;}
    .btn-edit{background-color:#0dcaf0;color:#000000;padding:6px 12px;border-radius:6px;text-decoration:none;font-weight:bold;font-size:14px;transition:background-color 0.3s ease;}
    .btn-edit:hover{background-color:#0aa5c0;}
    @media(max-width:768px){body{flex-direction:column;}.left-box{width:100%;height:auto;}}
  </style>
</head>
<body>

<div class="left-box">
  <h3>Opciones</h3>

  <div class="btn-group">
    <a href="?seccion=calificacion&accion=crear" class="btn btn-outline-light">Crear Calificación</a>
    <a href="?seccion=calificacion&accion=editar" class="btn btn-outline-light">Editar Calificación</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=usuario&accion=crear" class="btn btn-outline-light">Crear Usuario</a>
    <a href="?seccion=usuario&accion=editar" class="btn btn-outline-light">Editar Usuario</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=instrumento&accion=crear" class="btn btn-outline-light">Crear Instrumento</a>
    <a href="?seccion=instrumento&accion=editar" class="btn btn-outline-light">Editar Instrumento</a>
  </div>

  <div class="btn-group">
    <a href="?seccion=filtrar" class="btn btn-outline-light">Filtrar Calificaciones</a>
  </div>

  <h3 class="mt-4">Carga masiva</h3>
  <form method="post" action="{% url 'carga_masiva' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="archivo" accept=".json,.csv" required>
    <button type="submit" class="btn btn-outline-light mt-2">Subir archivo</button>
  </form>

  <div class="btn-group">
    <a href="{% url 'logout' %}" class="btn btn-outline-danger">Cerrar sesión</a>
  </div>
</div>

<div class="right-box">
  {% if seccion == 'calificacion' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Calificación</h2>
      <form method="post" action="{% url 'guardar_calificacion' %}">
        {% csrf_token %}
        <label>Monto ($)</label><input type="number" step="0.01" name="monto" required>
        <label>Factor (%)</label><input type="number" step="0.01" name="factor" required>
        <input type="month" name="periodo" max="{% now 'Y-m' %}" value="{% now 'Y-m' %}" required>
        <label>Instrumento</label>
        <select name="instrumento" required>
          <option value="">-- Seleccione --</option>
          {% for i in instrumentos %}<option value="{{ i.id_instru }}">{{ i.nombre }}</option>{% endfor %}
        </select>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>
        <label>UsuarioASC</label>
        <select name="usuario_id_usuario" required>
          <option value="">-- Seleccione</option>
          {% for u in usuarios %}<option value="{{ u.id_usuario }}">{{ u.nombre }}</option>{% endfor %}
        </select>
        <label>Factor Val</label>
        <select name="factor_val_id_factor" required>
          <option value="">-- Seleccione</option>
          {% for fv in factor_vals %}<option value="{{ fv.id_factor }}">{{ fv.id_factor }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Crear Calificación</button>
      </form>
    </div>

  {% elif seccion == 'calificacion' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione una Calificación para Editar</h2>
      <div class="sql-table">
        {% for c in calificaciones %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Instrumento:</strong> {{ c.instrumento.nombre }}<br>
              <strong>Período:</strong> {{ c.periodo|date:"m/Y" }}<br>
              <strong>Monto:</strong> ${{ c.monto|floatformat:0 }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=calificacion&accion=editar&obj_id={{ c.calid }}">Editar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'calificacion' and accion == 'editar' and obj_id %}
    <div class="card">
      <h2>Editar Calificación</h2>
      <form method="post" action="{% url 'guardar_calificacion' %}">
        {% csrf_token %}
        <input type="hidden" name="calid" value="{{ obj.calid }}">
        <label>Monto ($)</label><input type="number" step="0.01" name="monto" value="{{ obj.monto }}" required>
        <label>Factor (%)</label><input type="number" step="0.01" name="factor" value="{{ obj.factor }}" required>
        <label>Período</label><input type="month" name="periodo" value="{{ obj.periodo|date:'Y-m' }}" required>
        <label>Instrumento</label>
        <select name="instrumento" required>
          {% for i in instrumentos %}<option value="{{ i.id_instru }}" {% if obj.instrumento.id_instru == i.id_instru %}selected{% endif %}>{{ i.nombre }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'usuario' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Usuario</h2>
      <form method="post" action="{% url 'guardar_usuario' %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" required>
        <label>RUT (sin puntos, con guión)</label><input type="text" name="rut" required>
        <label>Email</label><input type="email" name="email" required>
        <label>Contraseña</label>
        <input type="password" name="password" required minlength="8" placeholder="Mínimo 8 caracteres">
        <label>Rol</label>
        <select name="rol" required>
          {% for r in roles %}<option value="{{ r.id_rol }}">{{ r.nombre_rol }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Crear Usuario</button>
      </form>
    </div>

  {% elif seccion == 'usuario' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Usuario para Editar</h2>
      <div class="sql-table">
        {% for u in usuarios %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Nombre:</strong> {{ u.nombre }}<br>
              <strong>RUT:</strong> {{ u.rut }}<br>
              <strong>Rol:</strong> {{ u.rol_id.nombre_rol }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=usuario&accion=editar&obj_id={{ u.id_usuario }}">Editar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'usuario' and accion == 'editar' and obj_id %}
    <div class="card">
      <h2>Editar Usuario</h2>
      <form method="post" action="{% url 'guardar_usuario' %}">
        {% csrf_token %}
        <input type="hidden" name="id_usuario" value="{{ obj.id_usuario }}">
        <label>Nombre</label><input type="text" name="nombre" value="{{ obj.nombre }}" required>
        <label>RUT</label><input type="text" name="rut" value="{{ obj.rut }}" required>
        <label>Email</label><input type="email" name="email" value="{{ obj.email }}" required>
        <label>Nueva Contraseña (opcional)</label>
        <input type="password" name="password" placeholder="Dejar vacío para mantener la actual">
        <label>Rol</label>
        <select name="rol" required>
          {% for r in roles %}<option value="{{ r.id_rol }}" {% if obj.rol_id.id_rol == r.id_rol %}selected{% endif %}>{{ r.nombre_rol }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'instrumento' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Instrumento</h2>
      <form method="post" action="{% url 'guardar_instrumento' %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" required>
        <label>Regla</label><textarea name="regla_es" class="form-control" rows="3" required></textarea>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>
        <button type="submit" class="btn-success mt-3">Crear Instrumento</button>
      </form>
    </div>

  {% elif seccion == 'instrumento' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Instrumento para Editar</h2>
      <div class="sql-table">
        {% for i in instrumentos %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Nombre:</strong> {{ i.nombre }}<br>
              <strong>Estado:</strong> {{ i.estado }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=instrumento&accion=editar&obj_id={{ i.id_instru }}">Editar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif seccion == 'instrumento' and accion == 'editar' and obj_id %}
    <div class="card">
      <h2>Editar Instrumento</h2>
      <form method="post" action="{% url 'guardar_instrumento' %}">
        {% csrf_token %}
        <input type="hidden" name="id_instru" value="{{ obj.id_instru }}">
        <label>Nombre</label><input type="text" name="nombre" value="{{ obj.nombre }}" required>
        <label>Regla</label><textarea name="regla_es" class="form-control" rows="3" required>{{ obj.regla_es }}</textarea>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO" {% if obj.estado == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
          <option value="INACTIVO" {% if obj.estado == 'INACTIVO' %}selected{% endif %}>INACTIVO</option>
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>

  {% elif seccion == 'filtrar' %}
    <div class="card">
      <h2>Filtrar Calificaciones</h2>
      <form method="get" action="{% url 'filtrar_calificaciones' %}">
        <label>RUT (sin puntos, con guión)</label><input type="text" name="rut">
        <label>Fecha (período)</label><input type="month" name="fecha">
        <label>Monto mínimo</label><input type="number" step="0.01" name="monto_min" placeholder="0">
        <label>Monto máximo</label><input type="number" step="0.01" name="monto_max" placeholder="999999999">
        <label>Tipo de instrumento</label><input type="text" name="instrumento" placeholder="Ej: Bono">
        <label>Factor Val ID</label><input type="number" name="factor_val" placeholder="Ej: 1">
        <button type="submit" class="btn-success mt-3">Buscar</button>
      </form>
    </div>
  {% endif %}
</div>

</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Operador - NUAM</title>
  <style>
    /* (tus estilos sin cambios) */
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;}
    body{
      display:flex;
      background:linear-gradient(135deg, #000000 0%, #1a0000 50%, #000000 100%);
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      color:#ffffff;
      position:relative;
      overflow:hidden;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,0,0,0.1) 50%, transparent 70%);
      animation: shine 3s infinite;
      pointer-events: none;
    }
    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .left-box{
      width:320px;
      height:100vh;
      background:rgba(0,0,0,0.8);
      padding:30px 20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      border-right:1px solid rgba(255,0,0,0.3);
      box-shadow: 0 0 20px rgba(255,0,0,0.3);
    }
    .left-box h3{
      font-size:18px;
      margin-bottom:10px;
      text-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
    .saludo-interno{
      width:100%;
      text-align:center;
      font-size:14px;
      color:#ffffff;
      background:linear-gradient(45deg, rgba(255,0,0,0.2), rgba(255,0,0,0.1));
      border:1px solid rgba(255,0,0,0.3);
      border-radius:6px;
      padding:6px 0;
      margin-bottom:10px;
      box-shadow: 0 0 10px rgba(255,0,0,0.2);
    }
    .btn-group{display:flex;gap:6px;}
    .btn{
      flex:1;
      height:36px;
      border:1px solid rgba(255,0,0,0.5);
      border-radius:6px;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      background:linear-gradient(45deg, rgba(255,0,0,0.2), rgba(255,0,0,0.1));
      color:#ffffff;
      transition:all 0.3s ease;
      text-shadow: 0 0 5px rgba(255,255,255,0.5);
    }
    .btn:hover{
      background:linear-gradient(45deg, rgba(255,0,0,0.4), rgba(255,0,0,0.3));
      box-shadow: 0 0 15px rgba(255,0,0,0.5);
      transform: translateY(-2px);
    }
    .btn-outline-light{
      background:transparent;
      color:#ffffff;
      border:1px solid rgba(255,255,255,0.3);
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    .btn-outline-light:hover{
      background:rgba(255,255,255,0.1);
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    .btn:disabled{
      background-color:#333;
      color:#666;
      border-color:#444;
      cursor:not-allowed;
      box-shadow: none;
    }
    .right-box{
      flex:1;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:40px 20px;
      overflow-y:auto;
    }
    .card{
      width:90%;
      max-width:420px;
      background:rgba(0,0,0,0.8);
      border:1px solid rgba(255,0,0,0.3);
      border-radius:12px;
      padding:30px;
      display:flex;
      flex-direction:column;
      gap:15px;
      box-shadow: 0 0 20px rgba(255,0,0,0.2);
    }
    .card h2{
      font-size:22px;
      text-align:center;
      margin-bottom:10px;
      text-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
    label{
      font-size:14px;
      margin-bottom:4px;
      color:rgba(255,255,255,0.9);
    }
    input,select,textarea{
      width:100%;
      height:48px;
      border:1px solid rgba(255,0,0,0.3);
      border-radius:8px;
      padding:0 15px;
      font-size:16px;
      background:rgba(0,0,0,0.5);
      color:#ffffff;
      outline:none;
      transition:all 0.3s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(255,0,0,0.5);
      box-shadow: 0 0 10px rgba(255,0,0,0.3);
    }
    input::placeholder{color:rgba(255,255,255,0.5);}
    .btn-success{
      width:100%;
      height:48px;
      border:1px solid rgba(0,255,0,0.5);
      border-radius:8px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      background:linear-gradient(45deg, rgba(0,255,0,0.2), rgba(0,255,0,0.1));
      color:#ffffff;
      transition:all 0.3s ease;
      text-shadow: 0 0 5px rgba(0,255,0,0.5);
    }
    .btn-success:hover{
      background:linear-gradient(45deg, rgba(0,255,0,0.3), rgba(0,255,0,0.2));
      box-shadow: 0 0 15px rgba(0,255,0,0.5);
      transform: translateY(-2px);
    }
    .sql-table{display:flex;flex-direction:column;gap:10px;}
    .sql-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:rgba(0,0,0,0.5);
      border:1px solid rgba(255,0,0,0.3);
      border-radius:8px;
      padding:12px 16px;
      transition:all 0.3s ease;
    }
    .sql-row:hover{
      background:rgba(255,0,0,0.1);
      box-shadow: 0 0 10px rgba(255,0,0,0.3);
    }
    .sql-cell{flex:1;font-size:14px;line-height:1.5;}
    .sql-action{margin-left:20px;}
    .btn-edit{
      background:linear-gradient(45deg, rgba(0,255,255,0.2), rgba(0,255,255,0.1));
      color:#ffffff;
      padding:6px 12px;
      border:1px solid rgba(0,255,255,0.5);
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      font-size:14px;
      transition:all 0.3s ease;
      text-shadow: 0 0 5px rgba(0,255,255,0.5);
    }
    .btn-edit:hover{
      background:linear-gradient(45deg, rgba(0,255,255,0.3), rgba(0,255,255,0.2));
      box-shadow: 0 0 15px rgba(0,255,255,0.5);
      transform: translateY(-2px);
    }
    @media(max-width:768px){
      body{flex-direction:column;}
      .left-box{width:100%;height:auto;}
    }

    ::-webkit-scrollbar{
      width:10px;
    }
    ::-webkit-scrollbar-track{
      background:rgba(0,0,0,0.3);
      border-radius:5px;
    }
    ::-webkit-scrollbar-thumb{
      background:linear-gradient(45deg, rgba(255,0,0,0.3), rgba(255,0,0,0.2));
      border-radius:5px;
    }
    ::-webkit-scrollbar-thumb:hover{
      background:linear-gradient(45deg, rgba(255,0,0,0.4), rgba(255,0,0,0.3));
    }
  </style>
</head>

<body>

{% if messages %}
  {% for message in messages %}
    {% if message.level_tag != 'success' %}
      <div class="alert alert-{{ message.level_tag }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
    {% endif %}
  {% endfor %}
{% endif %}

<div class="left-box">
  <h3>Opciones</h3>
  <div class="saludo-interno">Bienvenido, Operador</div>

  <div class="btn-group">
    {% if permisos.crear_calificacion %}
      <a href="?seccion=calificacion&accion=crear" class="btn btn-outline-light">Crear Calificación</a>
    {% else %}
      <button class="btn btn-outline-secondary" disabled title="Sin permiso">Crear Calificación</button>
    {% endif %}
    {% if permisos.editar_calificacion %}
      <a href="?seccion=calificacion&accion=editar" class="btn btn-outline-light">Editar Calificación</a>
    {% else %}
      <button class="btn btn-outline-secondary" disabled title="Sin permiso">Editar Calificación</button>
    {% endif %}
  </div>

  <div class="btn-group">
    {% if permisos.crear_usuario %}
      <a href="?seccion=usuario&accion=crear" class="btn btn-outline-light">Crear Usuario</a>
    {% else %}
      <button class="btn btn-outline-secondary" disabled title="Sin permiso">Crear Usuario</button>
    {% endif %}
    {% if permisos.editar_usuario %}
      <a href="?seccion=usuario&accion=editar" class="btn btn-outline-light">Editar Usuario</a>
    {% else %}
      <button class="btn btn-outline-secondary" disabled title="Sin permiso">Editar Usuario</button>
    {% endif %}
  </div>

  <div class="btn-group">
    {% if permisos.crear_instrumento %}
      <a href="?seccion=instrumento&accion=crear" class="btn btn-outline-light">Crear Instrumento</a>
    {% else %}
      <button class="btn btn-outline-secondary" disabled title="Sin permiso">Crear Instrumento</button>
    {% endif %}
    {% if permisos.editar_instrumento %}
      <a href="?seccion=instrumento&accion=editar" class="btn btn-outline-light">Editar Instrumento</a>
    {% else %}
      <button class="btn btn-outline-secondary" disabled title="Sin permiso">Editar Instrumento</button>
    {% endif %}
  </div>

  <div class="btn-group">
    {% if permisos.filtrar_calificaciones %}
      <a href="?seccion=filtrar" class="btn btn-outline-light">Filtrar Calificaciones</a>
    {% else %}
      <button class="btn btn-outline-secondary" disabled title="Sin permiso">Filtrar Calificaciones</button>
    {% endif %}
  </div>

  <h3 class="mt-4">Carga masiva</h3>
  {% if permisos.carga_masiva %}
    <form method="post" action="{% url 'carga_masiva' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="archivo" accept=".json,.csv" required>
      <button type="submit" class="btn btn-outline-light mt-2">Subir archivo</button>
    </form>
  {% else %}
    <button class="btn btn-outline-secondary" disabled title="Sin permiso">Subir archivo</button>
  {% endif %}

  <div class="btn-group">
    <a href="{% url 'logout' %}" class="btn btn-outline-danger">Cerrar sesión</a>
  </div>
</div>

<div class="right-box">
  {% if seccion == 'calificacion' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Calificación</h2>
      <form method="post" action="{% url 'guardar_calificacion' %}">
        {% csrf_token %}
        <label>Monto ($)</label>
        <input type="number" step="0.1" name="monto" min="0" placeholder="Ej: 500000.5" required oninput="if(this.value<0)this.value=''">
        <label>Factor (%)</label>
        <input type="number" step="0.1" name="factor" min="0" placeholder="Ej: 1.2" required oninput="if(this.value<0)this.value=''">
        <input type="month" name="periodo" max="{% now 'Y-m' %}" value="{% now 'Y-m' %}" required>
        <label>Instrumento</label>
        <select name="instrumento" required>
          <option value="">-- Seleccione --</option>
          {% for i in instrumentos %}<option value="{{ i.id_instru }}">{{ i.nombre }}</option>{% endfor %}
        </select>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>
        <label>Usuario</label>
        <select name="usuario_id_usuario" required>
          <option value="">-- Seleccione</option>
          {% for u in usuarios %}
            <option value="{{ u.id_usuario }}">{{ u.nombre }}</option>
          {% endfor %}
        </select>
        <label>Factor Val</label>
        <select name="factor_val_id_factor" required>
          <option value="">-- Seleccione</option>
          {% for fv in factor_vals %}
            <option value="{{ fv.id_factor }}">{{ fv.descripcion }} ({{ fv.rango_minimo }} - {{ fv.rango_maximo }})</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Crear Calificación</button>
      </form>
    </div>
  {% elif seccion == 'calificacion' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione una Calificación para Editar</h2>
      <div class="sql-table">
        {% for c in calificaciones %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Instrumento:</strong> {{ c.instrumento.nombre }}<br>
              <strong>Período:</strong> {{ c.periodo|date:"m/Y" }}<br>
              <strong>Monto:</strong> ${{ c.monto|floatformat:0 }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=calificacion&accion=editar&obj_id={{ c.calid }}">Editar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% elif seccion == 'calificacion' and accion == 'editar' and obj_id %}
    <div class="card">
      <h2>Editar Calificación</h2>
      <form method="post" action="{% url 'guardar_calificacion' %}">
        {% csrf_token %}
        <input type="hidden" name="calid" value="{{ obj.calid }}">

        <label>Monto ($)</label>
        <input type="number" step="0.1" name="monto" value="{{ obj.monto }}" min="0" required oninput="if(this.value<0)this.value=''">

        <label>Factor (%)</label>
        <input type="number" step="0.1" name="factor" value="{{ obj.factor }}" min="0" required oninput="if(this.value<0)this.value=''">

        <label>Período</label>
        <input type="month" name="periodo" value="{{ obj.periodo|date:'Y-m' }}" required>

        <label>Instrumento</label>
        <select name="instrumento" required>
          {% for i in instrumentos %}
            <option value="{{ i.id_instru }}" {% if obj.instrumento.id_instru == i.id_instru %}selected{% endif %}>{{ i.nombre }}</option>
          {% endfor %}
        </select>

        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO" {% if obj.estado == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
          <option value="INACTIVO" {% if obj.estado == 'INACTIVO' %}selected{% endif %}>INACTIVO</option>
        </select>

        <label>Dueño de la Calificación</label>
        <select name="usuario_id_usuario" required>
          {% for u in usuarios %}
            <option value="{{ u.id_usuario }}"
              {% if u.id_usuario == obj.usuario_id_usuario.perfil.id_usuario %}selected{% endif %}>
              {{ u.nombre }}
            </option>
          {% endfor %}
        </select>

        <label>Factor Val</label>
        <select name="factor_val_id_factor" required>
          {% for fv in factor_vals %}
            <option value="{{ fv.id_factor }}"
              {% if fv.id_factor == obj.factor_val_id_factor.id_factor %}selected{% endif %}>
              {{ fv.descripcion }} ({{ fv.rango_minimo }} - {{ fv.rango_maximo }})
            </option>
          {% endfor %}
        </select>

        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>
  {% elif seccion == 'usuario' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Usuario</h2>
      <form method="post" action="{% url 'guardar_usuario' %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" required>
        <label>RUT (sin puntos, con guión)</label>
        <input type="text" name="rut" required
               pattern="[0-9]{7,10}-[0-9kK]"
               title="Ej: 12345678-9 (solo números, sin espacios, con guión y dígito verificador)"
               oninput="this.value=this.value.replace(/[^0-9kK-]/g,'').toUpperCase(); if(this.value.slice(-1)!=='-' && this.value.length>1 && !this.value.includes('-')) this.value+='-';">
        <label>Email</label><input type="email" name="email" required>
        <label>Contraseña</label>
        <input type="password" name="password" required minlength="8" placeholder="Mínimo 8 caracteres">
        <label>Rol</label>
        <select name="rol" required>
          {% for r in roles %}<option value="{{ r.id_rol }}">{{ r.nombre_rol }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Crear Usuario</button>
      </form>
    </div>
  {% elif seccion == 'usuario' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Usuario para Editar</h2>
      <div class="sql-table">
        {% for u in usuarios %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Nombre:</strong> {{ u.nombre }}<br>
              <strong>RUT:</strong> {{ u.rut }}<br>
              <strong>Rol:</strong> {{ u.rol_id.nombre_rol }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=usuario&accion=editar&obj_id={{ u.id_usuario }}">Editar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% elif seccion == 'usuario' and accion == 'editar' and obj_id %}
    <div class="card">
      <h2>Editar Usuario</h2>
      <form method="post" action="{% url 'guardar_usuario' %}">
        {% csrf_token %}
        <input type="hidden" name="id_usuario" value="{{ obj.id_usuario }}">
        <label>Nombre</label><input type="text" name="nombre" value="{{ obj.nombre }}" required>
        <label>RUT</label>
        <input type="text" name="rut" value="{{ obj.rut }}" required
               pattern="[0-9]{7,10}-[0-9kK]"
               title="Ej: 12345678-9 (solo números, sin espacios, con guión y dígito verificador)"
               oninput="this.value=this.value.replace(/[^0-9kK-]/g,'').toUpperCase(); if(this.value.slice(-1)!=='-' && this.value.length>1 && !this.value.includes('-')) this.value+='-';">
        <label>Email</label><input type="email" name="email" value="{{ obj.email }}" required>
        <label>Nueva Contraseña (opcional)</label>
        <input type="password" name="password" placeholder="Dejar vacío para mantener la actual">
        <label>Rol</label>
        <select name="rol" required>
          {% for r in roles %}<option value="{{ r.id_rol }}" {% if obj.rol_id.id_rol == r.id_rol %}selected{% endif %}>{{ r.nombre_rol }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>
  {% elif seccion == 'instrumento' and accion == 'crear' %}
    <div class="card">
      <h2>Crear Instrumento</h2>
      <form method="post" action="{% url 'guardar_instrumento' %}">
        {% csrf_token %}
        <label>Nombre</label><input type="text" name="nombre" required>
        <label>Regla</label><textarea name="regla_es" class="solo-alphanumeric" rows="3" required></textarea>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>
        <button type="submit" class="btn-success mt-3">Crear Instrumento</button>
      </form>
    </div>
  {% elif seccion == 'instrumento' and accion == 'editar' and not obj_id %}
    <div class="card">
      <h2>Seleccione un Instrumento para Editar</h2>
      <div class="sql-table">
        {% for i in instrumentos %}
          <div class="sql-row">
            <div class="sql-cell">
              <strong>Nombre:</strong> {{ i.nombre }}<br>
              <strong>Estado:</strong> {{ i.estado }}
            </div>
            <div class="sql-action">
              <a class="btn-edit" href="?seccion=instrumento&accion=editar&obj_id={{ i.id_instru }}">Editar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% elif seccion == 'instrumento' and accion == 'editar' and obj_id %}
    <div class="card">
      <h2>Editar Instrumento</h2>
      <form method="post" action="{% url 'guardar_instrumento' %}">
        {% csrf_token %}
        <input type="hidden" name="id_instru" value="{{ obj.id_instru }}">
        <label>Nombre</label><input type="text" name="nombre" value="{{ obj.nombre }}" required>
        <label>Regla</label><textarea name="regla_es" class="solo-alphanumeric" rows="3" required>{{ obj.regla_es }}</textarea>
        <label>Estado</label>
        <select name="estado" required>
          <option value="ACTIVO" {% if obj.estado == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
          <option value="INACTIVO" {% if obj.estado == 'INACTIVO' %}selected{% endif %}>INACTIVO</option>
        </select>
        <button type="submit" class="btn-success mt-3">Guardar cambios</button>
      </form>
    </div>
    {% elif seccion == 'filtrar' %}
  <div class="card">
    <h2>Filtrar Calificaciones</h2>
    <form method="get" action="{% url 'filtrar_calificaciones' %}">

      <label>RUT (sin puntos, con guión) *</label>
      <input type="text" name="rut" required
             pattern="[0-9]{7,10}-[0-9kK]"
             title="Ej: 12345678-9 (solo números, sin espacios, con guión y dígito verificador)"
             oninput="this.value=this.value.replace(/[^0-9kK-]/g,'').toUpperCase(); if(this.value.slice(-1)!=='-' && this.value.length>1 && !this.value.includes('-')) this.value+='-';">

      <label>Fecha (período) *</label>
      <input type="month" name="fecha" required max="{% now 'Y-m' %}">

      <label>Monto mínimo *</label>
      <input type="text" name="monto_min" placeholder="0" required
             pattern="\d+(\.\d{0,1})?"
             title="Ej: 123456.7 (solo números y un decimal después del punto)"
             oninput="this.value=this.value.replace(/[^0-9.]/g,'').replace(/,/g,'').replace(/-/g,''); if((this.value.match(/\./g)||[]).length>1) this.value=this.value.slice(0,this.value.lastIndexOf('.')); if(parseFloat(this.value)<0) this.value='';"
             onblur="if(this.value) this.value=parseFloat(this.value).toFixed(1);">

      <label>Monto máximo *</label>
      <input type="text" name="monto_max" placeholder="9999999.9" required
             pattern="\d+(\.\d{0,1})?"
             title="Ej: 9999999.9 (solo números y un decimal después del punto)"
             oninput="this.value=this.value.replace(/[^0-9.]/g,'').replace(/,/g,'').replace(/-/g,''); if((this.value.match(/\./g)||[]).length>1) this.value=this.value.slice(0,this.value.lastIndexOf('.')); if(parseFloat(this.value)<0) this.value='';"
             onblur="if(this.value) this.value=parseFloat(this.value).toFixed(1);">

      <label>Instrumento</label>
      <select name="instrumento" required>
        <option value="">-- Todos --</option>
        {% for i in instrumentos %}
          <option value="{{ i.nombre }}">{{ i.nombre }}</option>
        {% endfor %}
      </select>

      <label>Factor Val</label>
      <select name="factor_val">
        <option value="">-- Todos --</option>
        {% for fv in factor_vals %}
          <option value="{{ fv.id_factor }}">{{ fv.descripcion }} ({{ fv.rango_minimo }} - {{ fv.rango_maximo }})</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn-success mt-3">Buscar</button>
    </form>
  </div>
{% endif %}
</div>

</body>
</html>